<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Flask | 伊森沃德·博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/statics/icon.png">
    <meta name="description" content="操作系统/编译原理/软件架构">
    
    <link rel="preload" href="/assets/css/0.styles.7cfabf05.css" as="style"><link rel="preload" href="/assets/js/app.c1f27e72.js" as="script"><link rel="preload" href="/assets/js/2.837ff8a6.js" as="script"><link rel="preload" href="/assets/js/27.c69e3cf6.js" as="script"><link rel="prefetch" href="/assets/js/10.150c7950.js"><link rel="prefetch" href="/assets/js/11.fe792822.js"><link rel="prefetch" href="/assets/js/12.acb41d84.js"><link rel="prefetch" href="/assets/js/13.c1bc46f2.js"><link rel="prefetch" href="/assets/js/14.d9d9122e.js"><link rel="prefetch" href="/assets/js/15.a9a84f78.js"><link rel="prefetch" href="/assets/js/16.72208984.js"><link rel="prefetch" href="/assets/js/17.be713cad.js"><link rel="prefetch" href="/assets/js/18.d66784b0.js"><link rel="prefetch" href="/assets/js/19.ee470907.js"><link rel="prefetch" href="/assets/js/20.8574d7c5.js"><link rel="prefetch" href="/assets/js/21.2af5d987.js"><link rel="prefetch" href="/assets/js/22.c30d4168.js"><link rel="prefetch" href="/assets/js/23.88409fc3.js"><link rel="prefetch" href="/assets/js/24.b5941148.js"><link rel="prefetch" href="/assets/js/25.ce833b37.js"><link rel="prefetch" href="/assets/js/26.008daf33.js"><link rel="prefetch" href="/assets/js/28.5508e1d2.js"><link rel="prefetch" href="/assets/js/29.2f3c6f33.js"><link rel="prefetch" href="/assets/js/3.dbefad83.js"><link rel="prefetch" href="/assets/js/30.095e7cc6.js"><link rel="prefetch" href="/assets/js/31.21edc416.js"><link rel="prefetch" href="/assets/js/32.80d445e2.js"><link rel="prefetch" href="/assets/js/33.0340985a.js"><link rel="prefetch" href="/assets/js/34.7230a4c5.js"><link rel="prefetch" href="/assets/js/35.a35cae3b.js"><link rel="prefetch" href="/assets/js/36.3dc15291.js"><link rel="prefetch" href="/assets/js/37.9e24e680.js"><link rel="prefetch" href="/assets/js/4.9db83892.js"><link rel="prefetch" href="/assets/js/5.241d3732.js"><link rel="prefetch" href="/assets/js/6.6033682a.js"><link rel="prefetch" href="/assets/js/7.ec21328a.js"><link rel="prefetch" href="/assets/js/8.8bf495ff.js"><link rel="prefetch" href="/assets/js/9.cf370094.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7cfabf05.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/statics/logo.png" alt="伊森沃德·博客" class="logo"> <span class="site-name can-hide">伊森沃德·博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/1.生活记录/" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="/2.操作系统/" class="nav-link">
  操作系统
</a></div><div class="nav-item"><a href="/3.编译原理/" class="nav-link">
  编译原理
</a></div><div class="nav-item"><a href="/4.通信协议/" class="nav-link">
  通信协议
</a></div><div class="nav-item"><a href="/5.数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/6.设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/7.工具效率/" class="nav-link">
  工具效率
</a></div><div class="nav-item"><a href="/8. Z语言/" class="nav-link">
   Z语言
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/1.生活记录/" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="/2.操作系统/" class="nav-link">
  操作系统
</a></div><div class="nav-item"><a href="/3.编译原理/" class="nav-link">
  编译原理
</a></div><div class="nav-item"><a href="/4.通信协议/" class="nav-link">
  通信协议
</a></div><div class="nav-item"><a href="/5.数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/6.设计模式/" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/7.工具效率/" class="nav-link">
  工具效率
</a></div><div class="nav-item"><a href="/8. Z语言/" class="nav-link">
   Z语言
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/6.%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/6.设计模式/django.html" class="sidebar-link">项目结构</a></li><li><a href="/6.设计模式/flask.html" class="active sidebar-link">Flask</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#wsgi" class="sidebar-link">WSGI</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#werkzeug" class="sidebar-link">WerkZeug</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#路由" class="sidebar-link">路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#注册路由" class="sidebar-link">注册路由</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#endpoint" class="sidebar-link">Endpoint</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#静态目录路由" class="sidebar-link">静态目录路由</a></li></ul></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#启动过程" class="sidebar-link">启动过程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#时序图" class="sidebar-link">时序图</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#服务器" class="sidebar-link">服务器</a></li></ul></li><li class="sidebar-sub-header"><a href="/6.设计模式/flask.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/6.设计模式/mongodb.html" class="sidebar-link">MongoDB</a></li><li><a href="/6.设计模式/pyqt.html" class="sidebar-link">/6.设计模式/pyqt.html</a></li><li><a href="/6.设计模式/vue.html" class="sidebar-link">参考文献</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#dep类" class="sidebar-link">Dep类</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#observer类" class="sidebar-link">Observer类</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#statemixin" class="sidebar-link">stateMixin</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#rendermixin" class="sidebar-link">renderMixin</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#lifecyclemixin" class="sidebar-link">lifecycleMixin</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#eventsmixin" class="sidebar-link">eventsMixin</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue.html#initmixin" class="sidebar-link">initMixin</a></li></ul></li><li><a href="/6.设计模式/vue3.html" class="sidebar-link">/6.设计模式/vue3.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/vue3.html#依赖管理" class="sidebar-link">依赖管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.设计模式/vue3.html#添加依赖" class="sidebar-link">添加依赖</a></li><li class="sidebar-sub-header"><a href="/6.设计模式/vue3.html#触发依赖" class="sidebar-link">触发依赖</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="flask"><a href="#flask" class="header-anchor">#</a> Flask</h1> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/202201052351332.png" alt="image-20220105235151287"></p> <h2 id="wsgi"><a href="#wsgi" class="header-anchor">#</a> WSGI</h2> <p>WSGI，全称 Web Server Gateway Interface，或者 Python Web Server Gateway Interface ，是基于 Python 定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。</p> <p><strong>WSGI接口的作用是确保HTTP请求能够转化成python应用的一个功能调用，这也就是Gateway的意义所在，网关的作用就是在协议之前进行转换</strong>。</p> <p>WSGI接口中有一个非常明确的标准，每个Python Web应用必须是可调用callable的对象且返回一个iterator，并实现了app(environ, start_response) 的接口，server 会调用 application，并传给它两个参数：environ 包含了请求的所有信息，start_response 是 application 处理完之后需要调用的函数，参数是状态码、响应头部还有错误信息。引用<a href="https://link.jianshu.com/?t=http://cizixs.com/2014/11/08/understand-wsgi" target="_blank" rel="noopener noreferrer">代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>示例：</p> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/202201052352008.png" alt="image-20220105235221968"></p> <p><strong>WEB应用的处理请求的整体流程：</strong></p> <ol><li>用户操作操作浏览器发送请求；</li> <li>请求转发至对应的web服务</li> <li><a href="https://www.zhihu.com/search?q=web%E6%9C%8D%E5%8A%A1%E5%99%A8&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A95942024%7D" target="_blank" rel="noopener noreferrer">web服务器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>将请求转交给<a href="https://www.zhihu.com/search?q=web%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A95942024%7D" target="_blank" rel="noopener noreferrer">web应用程序<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，web应用程序处理请求</li> <li>web应用将请求结果返回给web服务器，由web服务器返回用户响应结果</li> <li>浏览器收到响应，向用户展示</li></ol> <p>可以看到，请求时Web服务器需要和web应用程序进行通信，但是web服务器有很多种啊，Python web应用开发框架也对应多种啊，所以WSGI应运而生，定义了一套通信标准。试想一下，如果不统一标准的话，就会存在Web框架和Web服务器数据无法匹配的情况，那么开发就会受到限制，这显然不合理的。</p> <p><strong>WSGI的标准或规范是？</strong></p> <p>web服务器在将请求转交给web应用程序之前，需要先将http报文转换为WSGI规定的格式。</p> <p>WSGI规定，Web程序必须有一个可调用对象，且该可调用对象接收两个参数，返回一个可迭代对象：</p> <ul><li>environ：字典，包含请求的所有信息</li> <li>start_response：在可调用对象中调用的函数，用来发起响应，参数包括状态码，headers等</li></ul> <p><strong>实现一个简单WSGI服务</strong></p> <p>首先，我们编写一个符合WSGI标准的一个http处理函数：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">**</span><span class="token keyword">def</span><span class="token operator">**</span> <span class="token operator">**</span>hello<span class="token operator">**</span><span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    status <span class="token operator">**=</span><span class="token operator">**</span> <span class="token string">&quot;200 OK&quot;</span>
    response_headers <span class="token operator">**=</span><span class="token operator">**</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    start_response<span class="token punctuation">(</span>status<span class="token punctuation">,</span> response_headers<span class="token punctuation">)</span>
    path <span class="token operator">**=</span><span class="token operator">**</span> environ<span class="token punctuation">[</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">**</span><span class="token keyword">or</span><span class="token operator">**</span> <span class="token string">'hello'</span>
    <span class="token operator">**</span><span class="token keyword">return</span><span class="token operator">**</span> <span class="token punctuation">[</span><span class="token string">b'&lt;h1&gt; %s &lt;/h1&gt;'</span> <span class="token operator">**</span><span class="token operator">%</span><span class="token operator">**</span> path<span class="token operator">**</span><span class="token punctuation">.</span><span class="token operator">**</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><p>接下来，我们需要一个服务器启动WSGI服务器用来处理验证，使用Python内置的WSGI服务器模块wsgiref，<a href="http://xn--server-hw2j9811a.py" target="_blank" rel="noopener noreferrer">编写server.py<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token operator">*</span><span class="token comment"># coding:utf-8*</span>
<span class="token triple-quoted-string string">&quot;&quot;&quot;
desc: WSGI服务器实现
&quot;&quot;&quot;</span>
<span class="token operator">**</span><span class="token keyword">from</span><span class="token operator">**</span> wsgiref<span class="token punctuation">.</span>simple_server <span class="token operator">**</span><span class="token keyword">import</span><span class="token operator">**</span> make_server
<span class="token operator">**</span><span class="token keyword">from</span><span class="token operator">**</span> learn_wsgi<span class="token punctuation">.</span>client <span class="token operator">**</span><span class="token keyword">import</span><span class="token operator">**</span> hello

<span class="token operator">**</span><span class="token keyword">def</span><span class="token operator">**</span> <span class="token operator">**</span>main<span class="token operator">**</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    server <span class="token operator">**=</span><span class="token operator">**</span> make_server<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">8001</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>
    <span class="token operator">**</span><span class="token keyword">print</span><span class="token operator">**</span><span class="token punctuation">(</span><span class="token string">'Serving HTTP on port 8001...'</span><span class="token punctuation">)</span>
    server<span class="token operator">**</span><span class="token punctuation">.</span><span class="token operator">**</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">**</span><span class="token keyword">if</span><span class="token operator">**</span> __name__ <span class="token operator">**=</span><span class="token operator">=</span><span class="token operator">**</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>通过实现一个简单的WSGI服务，我们可以看到：通过environ可以获取http请求的所有信息，http响应的数据都可以通过start_response加上函数的返回值作为body。</p> <p><strong>Flask与WSG</strong></p> <p>Flask中的程序实例app就是一个可调用对象，我们创建app实例时所调用的Flask类实现了__call<strong>方法，__call</strong>方法调用了wsgi_app()方法，该方法完成了请求和响应的处理，WSGI服务器通过调用该方法传入请求数据，获取返回数据：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">wsgi_app</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ctx <span class="token operator">=</span> self<span class="token punctuation">.</span>request_context<span class="token punctuation">(</span>environ<span class="token punctuation">)</span>
    error <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            ctx<span class="token punctuation">.</span>push<span class="token punctuation">(</span><span class="token punctuation">)</span>
            response <span class="token operator">=</span> self<span class="token punctuation">.</span>full_dispatch_request<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            error <span class="token operator">=</span> e
            response <span class="token operator">=</span> self<span class="token punctuation">.</span>handle_exception<span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>  <span class="token comment"># noqa: B001</span>
            error <span class="token operator">=</span> sys<span class="token punctuation">.</span>exc_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">raise</span>
        <span class="token keyword">return</span> response<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>should_ignore_error<span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">:</span>
            error <span class="token operator">=</span> <span class="token boolean">None</span>
        ctx<span class="token punctuation">.</span>auto_pop<span class="token punctuation">(</span>error<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
</code></pre></div><h2 id="werkzeug"><a href="#werkzeug" class="header-anchor">#</a> WerkZeug</h2> <p>Werkzeug是一个WSGI工具包。WSGI是一个web应用和服务器通信的协议，web应用可以通过WSGI一起工作。一个基本的”Hello World”WSGI应用看起来是这样的:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">application</span><span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    start_response<span class="token punctuation">(</span><span class="token string">'200 OK'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'Hello World!'</span><span class="token punctuation">]</span>
</code></pre></div><p>上面这小段代码就是WSGI协议的约定，它有一个可调用的start_response 。environ包含了所有进来的信息。 start_response用来表明已经收到一个响应。 通过Werkzeug，我们可以不必直接处理请求或者响应这些底层的东西，它已经为我们封装好了这些。</p> <p>请求数据需要environ对象，Werkzeug允许我们以一个轻松的方式访问数据。响应对象是一个WSGI应用，提供了更好的方法来创建响应。如下所示：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> Response

 <span class="token keyword">def</span> <span class="token function">application</span><span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> Response<span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">,</span> mimetype<span class="token operator">=</span><span class="token string">'text/plain'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">(</span>environ<span class="token punctuation">,</span> start_response<span class="token punctuation">)</span>
</code></pre></div><h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <h3 id="注册路由"><a href="#注册路由" class="header-anchor">#</a> 注册路由</h3> <p>flassk路由的作用是为不同的HTTP URL注册不同的视图函数，框架提供了两种注册路由的方式：</p> <ul><li>方式1：通过@route装饰器，在Scaffold类中实现</li> <li>方式2：通过add_url_rule函数，在Scaffold中定义，Flask类继承Scaffold后对该函数重写</li></ul> <p>方式1源码如下：其本质也是通过调用方式2，只是相较而言，装饰器的方式让代码更优雅</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">route</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rule<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Callable<span class="token punctuation">:</span>
		<span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Callable<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Callable<span class="token punctuation">:</span>
				endpoint <span class="token operator">=</span> options<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&quot;endpoint&quot;</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
		    self<span class="token punctuation">.</span>add_url_rule<span class="token punctuation">(</span>rule<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> f<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span>
		    <span class="token keyword">return</span> f
		
		<span class="token keyword">return</span> decorator
</code></pre></div><p>方式2源码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">add_url_rule</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    rule<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    endpoint<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    view_func<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span>t<span class="token punctuation">.</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    provide_automatic_options<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token operator">**</span>options<span class="token punctuation">:</span> t<span class="token punctuation">.</span>Any<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		rule <span class="token operator">=</span> self<span class="token punctuation">.</span>url_rule_class<span class="token punctuation">(</span>rule<span class="token punctuation">,</span> methods<span class="token operator">=</span>methods<span class="token punctuation">,</span> <span class="token operator">**</span>options<span class="token punctuation">)</span>
    rule<span class="token punctuation">.</span>provide_automatic_options <span class="token operator">=</span> provide_automatic_options  <span class="token comment"># type: ignore</span>

    self<span class="token punctuation">.</span>url_map<span class="token punctuation">.</span>add<span class="token punctuation">(</span>rule<span class="token punctuation">)</span>
    <span class="token keyword">if</span> view_func <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        old_func <span class="token operator">=</span> self<span class="token punctuation">.</span>view_functions<span class="token punctuation">.</span>get<span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span>
        <span class="token keyword">if</span> old_func <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> old_func <span class="token operator">!=</span> view_func<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> AssertionError<span class="token punctuation">(</span>
                <span class="token string">&quot;View function mapping is overwriting an existing&quot;</span>
                <span class="token string-interpolation"><span class="token string">f&quot; endpoint function: </span><span class="token interpolation"><span class="token punctuation">{</span>endpoint<span class="token punctuation">}</span></span><span class="token string">&quot;</span></span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span>endpoint<span class="token punctuation">]</span> <span class="token operator">=</span> view_func
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><h3 id="endpoint"><a href="#endpoint" class="header-anchor">#</a> Endpoint</h3> <p>需s要注意的是， 框架中请求任务的分发并不是直接从用户请求的URL一步定位到视图函数， 两者之间还隔着一个访问点endpoint。Flask内部使用两张表维护路由：</p> <ul><li>url_map ：维护URL规则和endpoint的映射</li> <li>view_functions ：维护endpoint和视图函数的映射</li></ul> <p>如下图，以用户访问URL/home为例，Flask将首先利用url_map找到所请求URL对应的 endpoint，即访问点home，然后再利用view_functions表查找home这个访问点对应的视图函数，最终匹配到函数home()</p> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/202201052353697.png" alt="image-20220105235305668"></p> <p>关于访问点的命名规则有两种：</p> <ul><li>默认访问点：当我们使用route装饰器注册路由时，默认使用被装饰函数的函数名作为访问点；</li> <li>自定义访问点：可以在使用route装饰器或调用add_url_rule()方法注册路由时，使用endpoint关键字参数改变这一默认行为；</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> endpoint <span class="token operator">=</span> <span class="token string">'whocare'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		<span class="token keyword">pass</span>
</code></pre></div><p>通过endpoint关键字自定义路由对应的访问点，路由表对应规则即如下图：</p> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/202201052353320.png" alt="image-20220105235338278"></p> <p><strong>为什么需要endpoint做中间层？</strong></p> <div class="language- extra-class"><pre class="language-text"><code>endpoint`通常用来“反向查找”。例如，你想从一个页面跳转到另一个页面时，你可以使用`url_for(endpoint,**values)
@app.route('/') 
def index():
		# This will print '/greeting/Mark'
    print url_for('give_greeting', name='Mark')

@app.route('/greeting/&lt;name&gt;')
def give_greeting(name):
    return 'Hello, {0}!'.format(name)
</code></pre></div><p>因此，endpoint这种中间层的存在可以方便代码解耦，单独修改url不会影响现有的跳转实现。</p> <p><strong>endpoint源码如下，定义在Scaffold类中</strong></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">endpoint</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>Callable<span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">decorator</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>view_functions<span class="token punctuation">[</span>endpoint<span class="token punctuation">]</span> <span class="token operator">=</span> f
        <span class="token keyword">return</span> f
</code></pre></div><h3 id="静态目录路由"><a href="#静态目录路由" class="header-anchor">#</a> 静态目录路由</h3> <p>关s于静态目录路由的配置方式也有两种：</p> <ul><li>默认静态目录路由</li> <li>自定义静态目录路由</li></ul> <p>默认静态目录路由：当创建应用实例时，Flask将自动添加一条静态目录路由，其访问点始终被设置为static，URL规则默认被设置为/static，本地路径默认被设置为应用文件夹下的static子文件夹。例如如下目录，那么启动应用后就可以通过URL/static/main.css访问static文件夹下的main.css了。</p> <div class="language- extra-class"><pre class="language-text"><code>/app
    /web.py
    /static
        /main.css
        /jquery.min.js   
</code></pre></div><p>自定义静态目录路由 ：可以在创建应用对象时使用关键字参数static_folder改变 默认的静态文件夹。例如，你的静态文件都存放在应用下的assets目录下， 那么可以按如下的方式创建应用对象：</p> <div class="language- extra-class"><pre class="language-text"><code>// 改变默认的本地路径并不会对路由表产生影响。
app = Flask(name,static_folder='assets') // 相对路径
app = Flask(name,static_folder='/var/www/static') // 绝对路径
</code></pre></div><p>改变默认的URL规则 ： 如果不喜欢静态目录URL/static，也可以在创建应用 对象时使用关键字参数static_url_path换一个别的名字。下面的示例中，将应用下的assets文件夹注册为静态目录/assets：</p> <div class="language- extra-class"><pre class="language-text"><code>// 当应用运行后，通过URL/assets/main.css就可以访问assets文件夹下的 main.css文件了
app = Flask(name,static_folder='assets',static_url_path='/assets') 
</code></pre></div><h2 id="启动过程"><a href="#启动过程" class="header-anchor">#</a> 启动过程</h2> <p>以如下flask程序介绍框中整体流程。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

<span class="token comment"># 第一步：创建Flask类实例，类变量赋值以及构造函数初始化</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 第二步：路由注册</span>
<span class="token comment"># 装饰器在执行main函数之前就已经运行了，但是被装饰的函数只有在调用时才能运行。</span>
<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span>

<span class="token comment"># 第三步：运行flask主程序</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="时序图"><a href="#时序图" class="header-anchor">#</a> 时序图</h3> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/Flask%E6%97%B6%E5%BA%8F%E4%BA%A4%E4%BA%92.jpg" alt="Flask时序交互"></p> <h3 id="服务器"><a href="#服务器" class="header-anchor">#</a> 服务器</h3> <p>werkzeug中BaseWSGIServer类继承自Python自带http模块实现服务端：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">serve_forever</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> poll_interval<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Handle one request at a time until shutdown.

    Polls for shutdown every poll_interval seconds. Ignores
    self.timeout. If you need to do periodic tasks, do them in
    another thread.
    &quot;&quot;&quot;</span>
    self<span class="token punctuation">.</span>__is_shut_down<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># XXX: Consider using another file descriptor or connecting to the</span>
        <span class="token comment"># socket to wake this up instead of polling. Polling reduces our</span>
        <span class="token comment"># responsiveness to a shutdown request and wastes cpu at all other</span>
        <span class="token comment"># times.</span>
        <span class="token keyword">with</span> _ServerSelector<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> selector<span class="token punctuation">:</span>
            selector<span class="token punctuation">.</span>register<span class="token punctuation">(</span>self<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">)</span>

            <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>__shutdown_request<span class="token punctuation">:</span>
                ready <span class="token operator">=</span> selector<span class="token punctuation">.</span>select<span class="token punctuation">(</span>poll_interval<span class="token punctuation">)</span>
                <span class="token comment"># bpo-35017: shutdown() called during select(), exit immediately.</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>__shutdown_request<span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                <span class="token keyword">if</span> ready<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>_handle_request_noblock<span class="token punctuation">(</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>service_actions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__shutdown_request <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>__is_shut_down<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="参考资料"><a href="#参考资料" class="header-anchor">#</a> 参考资料</h2> <ul><li><strong><a href="https://zhuanlan.zhihu.com/p/161512795" target="_blank" rel="noopener noreferrer">WSGI协议及werkzeug-实践篇<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></li> <li><a href="https://www.zhihu.com/column/flaskquestions" target="_blank" rel="noopener noreferrer">Flask WEB开发100问<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><strong><a href="https://www.cnblogs.com/skyflask/p/9194191.html" target="_blank" rel="noopener noreferrer">Flask学习-Flask app启动过程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></li> <li><strong><a href="https://www.cnblogs.com/qiu-hua/p/12631523.html" target="_blank" rel="noopener noreferrer">flask 源码专题（一）：app.run()的背后<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></li> <li><strong><a href="https://zhuanlan.zhihu.com/p/95942024" target="_blank" rel="noopener noreferrer">WSGI到底是什么？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></li> <li><strong><a href="https://www.jianshu.com/p/c66d3adeaaed" target="_blank" rel="noopener noreferrer">什么是wsgi？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></strong></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/5/2022, 2:27:34 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/6.设计模式/django.html" class="prev">
        项目结构
      </a></span> <span class="next"><a href="/6.设计模式/mongodb.html">
        MongoDB
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c1f27e72.js" defer></script><script src="/assets/js/2.837ff8a6.js" defer></script><script src="/assets/js/27.c69e3cf6.js" defer></script>
  </body>
</html>
