<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>伊森沃德·博客</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/statics/icon.png">
    <meta name="description" content="操作系统/编译原理/软件架构">
    
    <link rel="preload" href="/assets/css/0.styles.7cfabf05.css" as="style"><link rel="preload" href="/assets/js/app.1b30f0f3.js" as="script"><link rel="preload" href="/assets/js/2.837ff8a6.js" as="script"><link rel="preload" href="/assets/js/26.daf24088.js" as="script"><link rel="prefetch" href="/assets/js/10.89f289d2.js"><link rel="prefetch" href="/assets/js/11.fe792822.js"><link rel="prefetch" href="/assets/js/12.de8c02d5.js"><link rel="prefetch" href="/assets/js/13.5035fa79.js"><link rel="prefetch" href="/assets/js/14.248247b2.js"><link rel="prefetch" href="/assets/js/15.1eaea27a.js"><link rel="prefetch" href="/assets/js/16.bf27f2f4.js"><link rel="prefetch" href="/assets/js/17.2bee18bd.js"><link rel="prefetch" href="/assets/js/18.e77b2920.js"><link rel="prefetch" href="/assets/js/19.43d89492.js"><link rel="prefetch" href="/assets/js/20.188ec4be.js"><link rel="prefetch" href="/assets/js/21.e6058436.js"><link rel="prefetch" href="/assets/js/22.e5a8d325.js"><link rel="prefetch" href="/assets/js/23.d188749c.js"><link rel="prefetch" href="/assets/js/24.e7a2121b.js"><link rel="prefetch" href="/assets/js/25.98cdfa31.js"><link rel="prefetch" href="/assets/js/27.a28ace1f.js"><link rel="prefetch" href="/assets/js/28.ea99cb8d.js"><link rel="prefetch" href="/assets/js/29.7a83d053.js"><link rel="prefetch" href="/assets/js/3.00bec470.js"><link rel="prefetch" href="/assets/js/30.a5a1d5d8.js"><link rel="prefetch" href="/assets/js/31.35ec0f2c.js"><link rel="prefetch" href="/assets/js/32.6ef2f62e.js"><link rel="prefetch" href="/assets/js/4.9db83892.js"><link rel="prefetch" href="/assets/js/5.241d3732.js"><link rel="prefetch" href="/assets/js/6.6033682a.js"><link rel="prefetch" href="/assets/js/7.ec21328a.js"><link rel="prefetch" href="/assets/js/8.d9439802.js"><link rel="prefetch" href="/assets/js/9.6b87bd6e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7cfabf05.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/statics/logo.png" alt="伊森沃德·博客" class="logo"> <span class="site-name can-hide">伊森沃德·博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/1.生活记录/" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="/2.操作系统/" class="nav-link">
  操作系统
</a></div><div class="nav-item"><a href="/3.编程语言/" class="nav-link">
  编程语言
</a></div><div class="nav-item"><a href="/4.编译原理/" class="nav-link">
  编译原理
</a></div><div class="nav-item"><a href="/5.网络编程/" class="nav-link">
  网络编程
</a></div><div class="nav-item"><a href="/6.软件架构/" class="nav-link">
  软件架构
</a></div><div class="nav-item"><a href="/7.数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/8.工具效率/" class="nav-link">
  工具效率
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/1.生活记录/" class="nav-link">
  生活记录
</a></div><div class="nav-item"><a href="/2.操作系统/" class="nav-link">
  操作系统
</a></div><div class="nav-item"><a href="/3.编程语言/" class="nav-link">
  编程语言
</a></div><div class="nav-item"><a href="/4.编译原理/" class="nav-link">
  编译原理
</a></div><div class="nav-item"><a href="/5.网络编程/" class="nav-link">
  网络编程
</a></div><div class="nav-item"><a href="/6.软件架构/" class="nav-link">
  软件架构
</a></div><div class="nav-item"><a href="/7.数据结构/" class="nav-link">
  数据结构
</a></div><div class="nav-item"><a href="/8.工具效率/" class="nav-link">
  工具效率
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/6.%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/" aria-current="page" class="sidebar-link">首页</a></li><li><a href="/6.软件架构/django.html" class="sidebar-link">项目结构</a></li><li><a href="/6.软件架构/flask.html" class="sidebar-link">/6.软件架构/flask.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.软件架构/flask.html#注册路由" class="sidebar-link">注册路由</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/flask.html#endpoint" class="sidebar-link">Endpoint</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/flask.html#静态目录路由" class="sidebar-link">静态目录路由</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/flask.html#时序图" class="sidebar-link">时序图</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/flask.html#服务器" class="sidebar-link">服务器</a></li></ul></li><li><a href="/6.软件架构/pyqt.html" class="sidebar-link">/6.软件架构/pyqt.html</a></li><li><a href="/6.软件架构/vue.html" class="sidebar-link">参考文献</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#dep类" class="sidebar-link">Dep类</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#observer类" class="sidebar-link">Observer类</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#statemixin" class="sidebar-link">stateMixin</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#rendermixin" class="sidebar-link">renderMixin</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#lifecyclemixin" class="sidebar-link">lifecycleMixin</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#eventsmixin" class="sidebar-link">eventsMixin</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue.html#initmixin" class="sidebar-link">initMixin</a></li></ul></li><li><a href="/6.软件架构/vue3.html" class="active sidebar-link">/6.软件架构/vue3.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.软件架构/vue3.html#依赖管理" class="sidebar-link">依赖管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/6.软件架构/vue3.html#添加依赖" class="sidebar-link">添加依赖</a></li><li class="sidebar-sub-header"><a href="/6.软件架构/vue3.html#触发依赖" class="sidebar-link">触发依赖</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>packages/vue/src/index.ts</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">compileToFunction</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">template</span><span class="token operator">:</span> string <span class="token operator">|</span> HTMLElement<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> CompilerOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> RenderFunction
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">)</span>
  <span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> RenderFunction<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>packages/compiler-dom/src/index.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> parserOptions<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>packages/compiler-core/src/compile.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">baseCompile</span><span class="token punctuation">(</span>template<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> RootNode<span class="token punctuation">,</span> options<span class="token operator">:</span> CompilerOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> CodegenResult
<span class="token punctuation">{</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">baseParse</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span> <span class="token operator">:</span> template
  <span class="token function">transform</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>prefixIdentifiers<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>package目录说明：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>├── packages              
│   ├── compiler-core    // 核心编译器（平台无关）
│   ├── compiler-dom     // dom编译器
│   ├── compiler-sfc     // vue单文件编译器
│   ├── compiler-ssr     // 服务端渲染编译
│   ├── global.d.ts      // typescript声明文件
│   ├── reactivity       // 响应式模块，可以与任何框架配合使用
│   ├── runtime-core     // 运行时核心实例相关代码（平台无关）
│   ├── runtime-dom      // 运行时dom 关api，属性，事件处理
│   ├── runtime-test     // 运行时测试相关代码
│   ├── server-renderer   // 服务端渲染
│   ├── sfc-playground    // 单文件组件在线调试器
│   ├── shared             // 内部工具库,不对外暴露API
│   ├── size-check          // 简单应用，用来测试代码体积
│   ├── template-explorer  // 用于调试编译器输出的开发工具
│   └── vue                 // 面向公众的完整版本, 包含运行时和编译器
</code></pre></div><p>通过上面源码结构，可以看到有下面几个模块比较特别：</p> <ul><li>compiler-core</li> <li>compiler-dom</li> <li>runtime-core</li> <li>runtime-dom</li></ul> <p>可以看到core, dom 分别出现了两次，那么compiler和runtime它们之间又有什么区别呢？</p> <ul><li>compile：我们可以理解为程序编绎时，是指我们写好的源代码在被编译成为目标文件这段时间，可以通俗的看成是我们写好的源代码在被构建工具转换成为最终可执行的文件这段时间，在这里可以理解为我们将.vue文件编绎成浏览器能识别的.js文件的一些工作。</li> <li>runtime：可以理解为程序运行时，即是程序被编译了之后，在浏览器打开程序并运行它直到程序关闭的这段时间的系列处理。</li></ul> <p>在package目录下，除了上面列举的4个目录外，还有reactivity目录比较重要，他是响应式模块的源码，由于Vue 3整体源码采用的Monorepo规范，所以其下面每个子模块都可以独立编译和打包，从而独立对外提供服务，在使用时采用require('@vue/reactivity')引入，进入reactivity目录下可以看到有对应的package.json文件。</p> <p>其他目录：compiler-sfc是一个单文件组件编译工具，server-renderer目录是服务端渲染模块的源码，sfc-playground是一个在线Vue单文件组件调试工具，shared目录则包括了常用的工具库方法的源码，size-check是一个工具，可以用来测试代码体积，template-explorer用于调试编译器输出的开发工具，最后的vue目录则是Vue.js的完整源码产生目录。</p> <h1 id="monorepo"><a href="#monorepo" class="header-anchor">#</a> <code>Monorepo</code></h1> <blockquote><p><code>Monorepo</code>是管理代码的一种方式，它是指在一个项目仓库（repo）下管理多个包</p></blockquote> <ul><li>一个仓库中维护多个包</li> <li>便于版本管理、依赖管理，模块间的引用，调用都非常的方便</li> <li>缺点就是仓库的体积会变大</li></ul> <h1 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h1> <ul><li><strong><code>reactivity</code></strong>:响应式系统</li> <li><strong><code>runtime-core</code></strong>:与平台无关的运行时核心 (可以创建针对特定平台的运行时 - 自定义渲染器)</li> <li><strong><code>runtime-dom</code></strong>: 针对浏览器的运行时。包括<code>DOM API</code>，属性，事件处理等</li> <li><strong><code>runtime-test</code></strong>:用于测试</li> <li><strong><code>server-renderer</code></strong>:用于服务器端渲染</li> <li><strong><code>compiler-core</code></strong>:与平台无关的编译器核心</li> <li><strong><code>compiler-dom</code></strong>: 针对浏览器的编译模块</li> <li><strong><code>compiler-ssr</code></strong>: 针对服务端渲染的编译模块</li> <li><strong><code>compiler-sfc</code></strong>: 针对单文件解析</li> <li><strong><code>size-check</code></strong>:用来测试代码体积</li> <li><strong><code>template-explorer</code></strong>：用于调试编译器输出的开发工具</li> <li><strong><code>shared</code></strong>：多个包之间共享的内容</li> <li><strong><code>vue</code></strong>:完整版本,包括运行时和编译器</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/ethanworld/images@main/202205021330037.jpg" alt="img"></p> <h1 id="响应系统"><a href="#响应系统" class="header-anchor">#</a> 响应系统</h1> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// JS是单线程，activeEffect指向最后一个ReactiveEffect实例</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> activeEffect<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">undefined</span>

<span class="token keyword">class</span> <span class="token class-name">ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> activeEffect
    <span class="token comment">// activeEffect指向当前实例</span>
    activeEffect <span class="token operator">=</span> <span class="token keyword">this</span>
    trackOpBit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">++</span>effectTrackDepth
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">initDepMarkers</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">cleanupEffect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义依赖集合，集合元素为函数</span>
<span class="token keyword">type</span> <span class="token class-name">Dep</span> <span class="token operator">=</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span> <span class="token operator">&amp;</span> TrackedMarkers
<span class="token comment">// 定义对象主键与依赖集合之间的映射关系</span>
<span class="token keyword">type</span> <span class="token class-name">KeyToDepMap</span> <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;</span>
<span class="token comment">// 定义对象与其子键映射关系的映射，target为如何JS对象</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>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</p> <h2 id="依赖管理"><a href="#依赖管理" class="header-anchor">#</a> 依赖管理</h2> <h3 id="添加依赖"><a href="#添加依赖" class="header-anchor">#</a> 添加依赖</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 触发添加依赖的时机</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TrackOpTypes <span class="token punctuation">{</span>
  <span class="token constant">GET</span> <span class="token operator">=</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
  <span class="token constant">HAS</span> <span class="token operator">=</span> <span class="token string">'has'</span><span class="token punctuation">,</span>
  <span class="token constant">ITERATE</span> <span class="token operator">=</span> <span class="token string">'iterate'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 跟踪目标：将target的key与activeEffect构建绑定关系</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token operator">:</span> object<span class="token punctuation">,</span> type<span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack <span class="token operator">&amp;&amp;</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token function">createDep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> eventInfo <span class="token operator">=</span> __DEV__
      <span class="token operator">?</span> <span class="token punctuation">{</span> effect<span class="token operator">:</span> activeEffect<span class="token punctuation">,</span> target<span class="token punctuation">,</span> type<span class="token punctuation">,</span> key <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token keyword">undefined</span>

    <span class="token function">trackEffects</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> eventInfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trackEffects</span><span class="token punctuation">(</span>
  dep<span class="token operator">:</span> Dep<span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> shouldTrack <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectTrackDepth <span class="token operator">&lt;=</span> maxMarkerBits<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">newTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep<span class="token punctuation">.</span>n <span class="token operator">|=</span> trackOpBit <span class="token comment">// set newly tracked</span>
      shouldTrack <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">wasTracked</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Full cleanup mode.</span>
    shouldTrack <span class="token operator">=</span> <span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加依赖</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token operator">!</span><span class="token punctuation">)</span>
    activeEffect<span class="token operator">!</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="触发依赖"><a href="#触发依赖" class="header-anchor">#</a> 触发依赖</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 触发依赖的几种场景：写（改）、添加（增）、删除（删）、清楚（删）</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> TriggerOpTypes <span class="token punctuation">{</span>
  <span class="token constant">SET</span> <span class="token operator">=</span> <span class="token string">'set'</span><span class="token punctuation">,</span>
  <span class="token constant">ADD</span> <span class="token operator">=</span> <span class="token string">'add'</span><span class="token punctuation">,</span>
  <span class="token constant">DELETE</span> <span class="token operator">=</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
  <span class="token constant">CLEAR</span> <span class="token operator">=</span> <span class="token string">'clear'</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  type<span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  newValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 局部变量，构建依赖</span>
  <span class="token keyword">let</span> deps<span class="token operator">:</span> <span class="token punctuation">(</span>Dep <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
  <span class="token comment">// 遍历deps，</span>
  <span class="token function">triggerEffect</span><span class="token punctuation">(</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">triggerEffect</span><span class="token punctuation">(</span>
  effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">,</span>
  debuggerEventExtraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> effect<span class="token punctuation">.</span>allowRecurse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>scheduler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/9/2022, 3:42:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/6.软件架构/vue.html" class="prev">
        参考文献
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1b30f0f3.js" defer></script><script src="/assets/js/2.837ff8a6.js" defer></script><script src="/assets/js/26.daf24088.js" defer></script>
  </body>
</html>
